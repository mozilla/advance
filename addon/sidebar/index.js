!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5)}([function(e,t,r){"use strict";(function(e){r.d(t,"g",function(){return i}),r.d(t,"h",function(){return o}),r.d(t,"f",function(){return a}),r.d(t,"c",function(){return c}),r.d(t,"a",function(){return u}),r.d(t,"d",function(){return d}),r.d(t,"e",function(){return h}),r.d(t,"b",function(){return l}),r.d(t,"i",function(){return f});var n=r(2);const i="object"==typeof e&&!("boolean"==typeof __DEV__&&!0===__DEV__);var s=!i;function o(e){s&&console.log(`production:${i} `+e)}function a(e){s&&console.error(e)}const c=i?"https://laserlike.com":"http://localhost:3000",u=void 0,d=i?"https://feed.laserlike.com":"https://feed-dev.laserlike.com",h=i?"https://feed.laserlike.com":"http://localhost:3000",l={apiServer:"api_server_url",webServer:"web_server_url",extensionOrigin:"extension_origin",userID:n.d.userId,token:n.d.token,compactMode:"compact_mode",paused:"paused",userDisplayName:"user_display_name",accountDeleted:"account_deleted",newTabUrl:"new_tab_url",ignoreDNT:"ignore_do_not_track"};function f(e){if(!e)return"";return(e=e.split("#")[0]).startsWith("about:reader?url=")?e=decodeURIComponent(e.slice("about:reader?url=".length)):(e.startsWith("about:")||e.startsWith("chrome:")||e.startsWith("chrome-extension:")||""===e)&&(e=n.c),e}}).call(this,r(3))},function(e,t,r){"use strict";r.d(t,"c",function(){return i}),r.d(t,"b",function(){return s}),r.d(t,"a",function(){return o}),r.d(t,"d",function(){return a});var n=r(0);async function i(e,t){Object(n.h)(`set persistent data in extension: ${e} = ${t}`);const r={name:e,value:t,url:n.c,expirationDate:2147483647},i=await browser.cookies.set(r);return Object(n.h)(`cookie set: ${JSON.stringify(i)}`),!!i}async function s(e){Object(n.h)(`read extension cookie: ${e} for url: ${n.c}`);const t={name:e,url:n.c},r=await browser.cookies.get(t);return Object(n.h)(`cookie read: ${JSON.stringify(r)}`),r?r.value:void 0}async function o(e){Object(n.h)(`delete extension cookie: ${e} for url: ${n.c}`);const t={name:e,url:n.c};return!!await browser.cookies.remove(t)}const a={myWindowId:null,paused:!1,userId:0,authToken:"",isLoggingIn:!1,accountDeleted:!1,newTabUrl:void 0,ignoreDNT:!1,API_SERVER:n.d,WEB_SERVER:n.e,activeTabs:{},focusedWindowId:-1,fetchRequestCredentials:"include"}},function(e,t,r){"use strict";let n;r.d(t,"c",function(){return c}),r.d(t,"d",function(){return l}),r.d(t,"b",function(){return f}),r.d(t,"a",function(){return g});const i=3e5,s=36e5,o=3600,a=1e7,c="FOR_YOU",u={get login(){return`${n.apiServer}/auth/api/v1/login`},get updateEmail(){return`${n.apiServer}/auth/api/v1/update-email`},get emailValidate(){return`${n.apiServer}/auth/api/v1/email/validate`},get sendVerification(){return`${n.apiServer}/auth/api/v1/email/sendverification?verification_method=2`},get deleteAccount(){return`${n.apiServer}/auth/api/v1/delete-account`},get preferences(){return`${n.apiServer}/auth/api/v1/user/preferences`},get managePreferences(){return`${n.apiServer}/auth/api/v1/user/manage-preferences`},get log(){return`${n.apiServer}/logging/api/v1/log`},get trendfeed(){return`${n.apiServer}/searchlike/api/v1/trendfeed`},get related(){return`${n.apiServer}/searchlike/api/v1/related`},get profile(){return`${n.apiServer}/searchlike/api/v1/profile`},get getProfile(){return`${n.apiServer}/searchlike/api/v1/get_profile`},get defaultTab(){return`${n.webServer}/`},get downloadData(){return`${n.apiServer}/account/data/download/`}},d={email:"Email Feedback",notInteresting:"Not Interesting",offTopic:"Off-Topic / Spam",block:"Block"},h={DEFAULT:0,FALSE:1,CONFIRMED:2},l={userId:"user_id",token:"token"};class f{constructor(e,t,r,n,i,s,o,a,c,u){this.clientInfo=e,this.apiServer=t,this.webServer=r,this.LRU=n,this.debugMode=i,this.setPersistData=s,this.getPersistData=o,this.deletePersistData=a,this.Log=c,this.Error=u}}class g{constructor(e){e.Log(`new client... ${e.clientInfo}`),n=e,this.isLoggingIn=!1,this.previousReadUrl=void 0,this.previousReadTime=void 0,this.feedCache=new v(this),this.pendingLogins=[],this.checkLogin=(async()=>{this.userId=await n.getPersistData(l.userId),this.authToken=await n.getPersistData(l.token)}),this.checkLogin()}isLoggedIn(){return this.userId&&this.authToken}async fetchRelated(e){n.Log(`async fetchRelated ${e}`);let t=this.feedCache.get(e,this.authToken,!0);if(Promise.resolve(t)!==t){return n.Log(`use existing ${e} feed`),t.removeCardsWithFeedback().cards}{n.Log(`start new fetch request ${e}`);let r=await t;return n.Log(`end fetch ${e}`),r.removeCardsWithFeedback().cards}}async fetchForYou(){if(this.isLoggedIn()){let e=this.feedCache.get(c,this.authToken,!0);if(Promise.resolve(e)!==e){return n.Log("use existing foryou feed"),e.removeCardsWithFeedback().cards}return n.Log("start new for you request"),(await e).removeCardsWithFeedback().cards}return this.login(),[]}handle401(){n.Error("401: reject by server"),this.userId=void 0,this.authToken=void 0,n.deletePersistData(l.userId),n.deletePersistData(l.token),this.previousReadUrl=void 0,this.previousReadTime=void 0,this.login()}logReadCard(e,t,r,n){if(!this.isLoggedIn())return void this.login();const i={eventType:"start",deviceTimeUnixMicros:1e3*Date.now(),read:{cardURL:e,uiElement:"browser",position:t,feed_type:r,logging_tags:n}};this.sendLog([i])}logReadStart(e){if(!this.isLoggedIn())return void this.login();const t=Date.now();var r=[{eventType:"start",deviceTimeUnixMicros:1e3*t,read:{cardURL:e,uiElement:"browser"}}];if(this.previousReadTime&&this.previousReadUrl){const e={cardURL:this.previousReadUrl,uiElement:"browser"};r.push({eventType:"end",deviceTimeUnixMicros:1e3*t,deviceDurationMicros:1e3*(t-this.previousReadTime),read:e})}this.previousReadTime=t,this.previousReadUrl=e,this.sendLog(r)}logReadEnd(e,t){if(!this.isLoggedIn())return void this.login();const r=Date.now(),n={eventType:"end",deviceTimeUnixMicros:1e3*r,deviceDurationMicros:1e3*(r-t),read:{cardURL:e,uiElement:"browser"}};this.sendLog([n])}setUserDisplayName(e,t){var r={name:e};let i={method:"POST",headers:new Headers({Accept:"application/json",Authorization:`Token ${this.authToken}`}),body:JSON.stringify(r),credentials:"include"},s=new Request(u.profile,i);return fetch(s).then(e=>{n.Log(`names returned ${e.status}`),t(e)})}sendLog(e){let t=[];for(let r=0;r<e.length;r++)t.push({clientInfo:n.clientInfo,userActivity:e[r]});const r={entries:t};let i={method:"POST",headers:new Headers({Accept:"application/json",Authorization:`Token ${this.authToken}`}),body:JSON.stringify(r),credentials:"include"},s=new Request(u.log,i);return fetch(s).then(e=>(n.Log(`logging returned ${e.status}`),401===e.status&&this.handle401(),200===e.status))}deleteAccount(e,t){const r=new Headers({Accept:"application/json",Authorization:`Token ${this.authToken}`}),i=new Request(u.deleteAccount,{method:"POST",headers:r,body:"{}",credentials:"include"});return n.Log("BG$ deleting account...."),fetch(i).then(r=>{200===r.status?e():t(r.status)}).catch(e=>{Error(`BG$ delete account error: ${e}`),t(999,e)})}validateUserEmail(e,t,r,i){var s={id:e,passcode:t};let o={method:"POST",headers:new Headers({Accept:"application/json",Authorization:`Token ${this.authToken}`}),body:JSON.stringify(s),credentials:"include"},a=new Request(u.emailValidate,o);return fetch(a).then(e=>{n.Log(`validate code returned ${e.status}`),200===e.status?r():e.json().then(t=>{n.Log(`error json: ${t}`),i(e.status,t.error)})}).catch(e=>{i(999,e)})}manageUserPreferences(e,t,r){var i={email:{unsubscription_map:{EmailDigest:e?2:1}}};const s=new Headers({Accept:"application/json",Authorization:`Token ${this.authToken}`}),o=new Request(u.managePreferences,{method:"POST",headers:s,body:JSON.stringify(i),credentials:"include"});return n.Log("updating user preferences...."),fetch(o).then(e=>{200===e.status?t():r(e.status)}).catch(e=>{Error(`updating user preferences error: ${e}`),r(999,e)})}updateUserEmail(e,t,r){var i={email:e,verification_method:2};let s={method:"POST",headers:new Headers({Accept:"application/json",Authorization:`Token ${this.authToken}`}),body:JSON.stringify(i),credentials:"include"},o=new Request(u.updateEmail,s);return fetch(o).then(i=>{n.Log(`update email returned ${i.status}`),200===i.status?t(e,!1):i.json().then(e=>{n.Log(`error json: ${e}`),r(i.status,e.error)})}).catch(e=>{r(999,e)})}resendEmailVerification(e,t){n.Log("resend email verification");let r={method:"GET",headers:new Headers({Accept:"application/json",Authorization:`Token ${this.authToken}`}),credentials:"include"},i=new Request(u.sendVerification,r);return fetch(i).then(r=>{200===r.status?e():r.json().then(e=>{n.Log(`error json: ${e}`),t(r.status,e.error)})}).catch(e=>{t(999,e)})}fetchUserProfile(e,t){n.Log("fetch user profile...");let r={method:"GET",headers:new Headers({Accept:"application/json",Authorization:`Token ${this.authToken}`}),credentials:"include"},i=new Request(u.getProfile,r);return fetch(i).then(r=>{n.Log(`fetch user profile result: ${r.status}`),200===r.status?r.json().then(t=>{const r=t.email_confirmed===h.CONFIRMED,i=t.email||"";n.Log(`email: ${i}, confirmed: ${r}`),e(i,r)}):t(r.status)}).catch(e=>{t(999,e)})}fetchUserPreferences(e,t){n.Log("fetch user preferences...");let r={method:"GET",headers:new Headers({Accept:"application/json",Authorization:`Token ${this.authToken}`}),credentials:"include"},i=new Request(u.preferences,r);return fetch(i).then(r=>{n.Log(`fetch user preferences result: ${r.status}`),200===r.status?r.json().then(t=>{let r=!1;const n=t.email_preferences;if(n){n.settings.forEach(e=>{8===e.type&&(r=e.subscribed)})}e(r)}):t(r.status)}).catch(e=>{t(999,e)})}loginInternal(e,t){var r={social_flag:"firefox"};n.debugMode?(r.oauth_token="laserlike-test-device-id",n.Log("login in as new test user ....")):n.Log("login in as new user ....");let i=new Headers({Accept:"application/json"}),s={method:"POST",body:JSON.stringify(r),headers:i,credentials:"include"},o=new Request(u.login,s);return fetch(o).then(r=>{n.Log(`login returned ${r.status}`),200===r.status?r.json().then(r=>{n.Log(JSON.stringify(r)),r.user_id&&r.auth_token?e(r.user_id,r.auth_token):t(999,"unknown response")}):t(r.status)}).catch(e=>{t(998,e)})}login(e,t,r=0){if(this.userId&&this.authToken)return void(e&&e(this.userId,this.authToken));if(e&&this.pendingLogins.push({success:e,failure:t}),this.isLoggingIn)return;this.isLoggingIn=!0;this.loginInternal((e,t)=>{for(this.isLoggingIn=!1,this.userId=e,this.authToken=t,n.setPersistData(l.userId,this.userId),n.setPersistData(l.token,this.authToken),n.Log(`got user id: ${this.userId} token: ${this.authToken}`),this.feedCache.get(c,this.authToken,!0);this.pendingLogins.length>0;){const e=this.pendingLogins.shift();e.success&&e.success(this.userId,this.authToken)}},(e,t)=>{if(n.Error(`login failed: ${e}, ${t}`),this.isLoggingIn=!1,r>22){for(;this.pendingLogins.length>0;){const e=this.pendingLogins.pop();e.failure&&e.failure()}return}(r*=2)<1&&(r=1);let i=1e3*r;i>72e5&&(i=72e5),setTimeout(()=>{this.login(void 0,void 0,r)},i)})}blockCardsFromHostExcept(e,t){this.feedCache.cache.values().forEach(r=>{r.cards.forEach(r=>{r.host===e&&r.card_id!==t.card_id&&(n.Log(`block ${t.title}`),r.sentFeedback=d.block)})})}}class p{constructor(e){const{card_id:t,position:r,url:n,orig_url:i,title:s,host:o,display_host:a,description:c,card_age_time_sec:u,article:d,feed_type:h,logging_tags:l}=e;this.card_id=t,this.position=r,this.url=n,this.orig_url=i,this.title=s,this.host=a||o,this.description=c,this.card_age_time_sec=u,this.image_url=d.image_url,this.feed_type=h,this.logging_tags=l,this.sentFeedback=void 0}get elementId(){return`card-${this.card_id}`}get unoElementId(){return`undo-${this.card_id}`}emailBody(e,t,r){return`{\n      userId: ${e},\n      display_name: ${t}\n      email: ${r}\n      card:\n      { card_id: ${this.card_id},\n        position: ${this.position},\n        url: "${this.url}",\n        orig_url: "${this.orig_url}",\n        host: ${this.host},\n        card_age_time_sec: ${this.card_age_time_sec},\n        image_url: "${this.image_url}",\n      },\n    }`}get length(){return JSON.stringify(this).length}}class m{constructor(e,t){this.url=e,this.count=t.count,this.fetchTime=Date.now(),this.ttl=t.ttl||0,this.cards=(t.cards||[]).map(e=>new p(e))}expired(){if(this.url===c){const e=Math.max(i,this.ttl);return Date.now()-this.fetchTime>e}return Date.now()-this.fetchTime>s}length(){return this.cards&&this.url?this.url.length+this.cards.reduce(function(e,t){return e+t.length},0):0}removeCardsWithFeedback(){return n.Log(`removeCardsWithFeedback: feed ${this.url} has ${this.cards.length} cards`),this.cards=this.cards.filter(e=>!e.sentFeedback),n.Log(`feed ${this.url} has ${this.cards.length} cards`),this}}class v{constructor(e){this.core=e,this.cache=n.LRU({max:a,length:(e,t)=>e.length()+t.length}),this.fetchPromises=n.LRU({max:100,maxAge:6e4})}clear(){this.cache.reset(),this.fetchPromises.reset()}get(e,t,r){let i=this.cache.get(e);const s=!i||i&&i.expired();n.Log(`FeedCache$ get ${e}, fetching: ${s}`);let o=this.fetchPromises.get(e);return!o&&s&&(o=this.fetchFeed(e,t,r),this.fetchPromises.set(e,o)),i&&!s?i:o}set(e,t){n.Log(`FeedCache$ saving feed ${e}`);let r=new m(e,t);return this.cache.get(c),this.cache.set(e,r),r}fetchFeed(e,t,r,i=1){n.Log(`FeedCache$ fetching ${e} token: ${t}, ${r}...`);let s,a=new Headers({Accept:"application/json",Authorization:`Token ${t}`});if(e===c){let e={method:"POST",body:JSON.stringify({client_info:n.clientInfo,tf_trend:{key:{type:2}},last_card_pos:"0"}),headers:a,credentials:"include"};s=new Request(u.trendfeed,e),i=0}else{let t={method:"POST",body:JSON.stringify({client_info:n.clientInfo,search_like:{vibe:[{target:{target:`u:${e}`}}]}}),headers:a,credentials:r?"include":"omit"};s=new Request(u.related,t)}return n.Log(`FeedCache$ before fetch: ${u.related}`),fetch(s).then(t=>{if(n.Log(`FeedCache$ fetch response: ${t.status} for ${u.related}`),401!==t.status)return 200===t.status?t.json().then(t=>{let r={cards:t.cards||[],ttl:1e3*(t.ttl||0)};return r.cards=r.cards.filter(e=>!!e.article&&!!e.orig_url),e!==c?(r.count=(t.search_like||{}).num_results_to_show_first||r.cards.length,r.count=Math.min(r.count,4)):r.count=r.cards.length,n.Log(`FeedCache$ got ${r.cards.length} new ${e} cards`),i&&r.ttl&&r.ttl<o&&(n.Log(`FeedCache$ retry in ${r.ttl} seconds`),setTimeout(()=>this.fetchFeed(e,i-1),r.ttl)),this.set(e,r)}):(n.Error(`FeedCache$ Fetch failed ${t.statusText}`),new m(e,[]));this.core.handle401()})}}},function(e,t){var r,n,i=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function a(e){if(r===setTimeout)return setTimeout(e,0);if((r===s||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:s}catch(e){r=s}try{n="function"==typeof clearTimeout?clearTimeout:o}catch(e){n=o}}();var c,u=[],d=!1,h=-1;function l(){d&&c&&(d=!1,c.length?u=c.concat(u):h=-1,u.length&&f())}function f(){if(!d){var e=a(l);d=!0;for(var t=u.length;t;){for(c=u,u=[];++h<t;)c&&c[h].run();h=-1,t=u.length}c=null,d=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===o||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function g(e,t){this.fun=e,this.array=t}function p(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];u.push(new g(e,t)),1!==u.length||d||a(f)},g.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=p,i.addListener=p,i.once=p,i.off=p,i.removeListener=p,i.removeAllListeners=p,i.emit=p,i.prependListener=p,i.prependOnceListener=p,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},,function(e,t,r){"use strict";r.r(t);var n,i,s,o,a=r(0),c=r(1),u=r(2);function d(e){"homePageChanged"!==e.method&&"loggedOut"!==e.method&&"loggedIn"!==e.method&&"pauseStateChanged"!==e.method?"mapOfOpenWindow"!==e.method?"newUrl"===e.method&&(e.normalizedUrl===u.c?h(e):(Object(a.h)(`${s} got url: ${e.url} ${e.normalizedUrl} myRoot: ${o}`),l(o).then(t=>{const r=Object(a.i)(t.url);Object(a.h)(`${s} current url: ${r}`),e.normalizedUrl===r&&(r===u.c&&(e.clearRelated=!0),h(e))}))):e.sideId===o&&(Object(a.h)(`${s} update my main window to: ${e.mainId}`),o=e.mainId):h(e)}function h(e){if(!i){let t=`${c.d.WEB_SERVER}${s}`;const r=document.querySelector("#panel");r.style.display="block";const o=document.createElement("iframe");o.src=`${t}`,Object(a.h)(`push to iframe ${t}: ${JSON.stringify(e)}`),n=new Promise(function(e){o.onload=e}),r.appendChild(o),i=o.contentWindow,Object(a.h)(`append iframe src: ${t}`)}Object(a.h)(`${s} posting to iframe ${c.d.WEB_SERVER}: ${JSON.stringify(e)}`),n.then(()=>i.postMessage(e,c.d.WEB_SERVER))}function l(e){let t={windowId:e||browser.windows.WINDOW_ID_CURRENT,active:!0};return browser.tabs.query(t).then(e=>{if(e&&!(e.length<1))return e[0]})}window.onload=(()=>(function(e){Object(a.h)(`init iframe: ${e}`),s=e,browser.runtime.onMessage.addListener(d);let t={url:a.c,name:a.b.webServer};a.a&&(t.firstPartyDomain=a.a),browser.cookies.get(t).then(e=>{e&&(c.d.WEB_SERVER=e.value)}),l().then(e=>{o=e.windowId,browser.runtime.sendMessage({method:"iframeActive",windowId:e.windowId,url:e.url,uiElement:s}),h({method:"newUrl",windowId:o,url:"about:blank",normalizedUrl:u.c}),setInterval(()=>{browser.runtime.sendMessage({method:"iframeAlive",windowId:e.windowId,uiElement:s})},1e3)})})("/sidebar"))}]);